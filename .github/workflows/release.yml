name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Cashew ${{ github.ref }}
        draft: false
        prerelease: false

  build-and-upload:
    name: Build and Upload Release Assets
    needs: create-release
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            artifact: cashew-node
            asset_name: cashew-linux-x64
          - os: windows-latest
            name: windows
            artifact: cashew_node.exe
            asset_name: cashew-windows-x64.exe
          - os: macos-latest
            name: macos
            artifact: cashew-node
            asset_name: cashew-macos-x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build pkg-config libsodium-dev libspdlog-dev nlohmann-json3-dev libssl-dev gcc-11 g++-11
    
    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake ninja libsodium spdlog nlohmann-json openssl
    
    - name: Setup MSYS2 (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-ninja
          mingw-w64-ucrt-x86_64-libsodium
          mingw-w64-ucrt-x86_64-spdlog
          mingw-w64-ucrt-x86_64-nlohmann-json
          mingw-w64-ucrt-x86_64-openssl
          mingw-w64-ucrt-x86_64-pkgconf
          zip
    
    - name: Build (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        mkdir -p build && cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCASHEW_BUILD_TESTS=OFF ..
        ninja
    
    - name: Build (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        mkdir -p build && cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCASHEW_BUILD_TESTS=OFF ..
        ninja
    
    - name: Package binary (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        strip build/src/${{ matrix.artifact }}
        tar -czf ${{ matrix.asset_name }}.tar.gz -C build/src ${{ matrix.artifact }}
    
    - name: Package binary (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        strip build/src/${{ matrix.artifact }}
        cd build/src && zip ../../${{ matrix.asset_name }}.zip ${{ matrix.artifact }}
    
    - name: Upload Release Asset (Linux/macOS)
      if: matrix.os != 'windows-latest'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./${{ matrix.asset_name }}.tar.gz
        asset_name: ${{ matrix.asset_name }}.tar.gz
        asset_content_type: application/gzip
    
    - name: Upload Release Asset (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./${{ matrix.asset_name }}.zip
        asset_name: ${{ matrix.asset_name }}.zip
        asset_content_type: application/zip
